<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>ABO výpis → HTML/PDF</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fafafa; --card:#fff; --accent:#0b57d0; }
    body{font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans"; color:var(--fg); background:var(--bg); margin:0; padding:2rem;}
    h1{font-size:1.6rem;margin:0 0 1rem}
    .uploader{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem}
    .drop{border:2px dashed #ccc; background: #fff; padding:1rem 1.2rem; border-radius:10px; flex:1 1 320px; min-height:70px; display:flex; align-items:center; justify-content:center; text-align:center; color:var(--muted)}
    .drop.drag{border-color:var(--accent); color:var(--accent); background:#eef3fe}
    .btn{appearance:none;border:1px solid #ddd;background:#fff;padding:0.6rem 0.9rem;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .cards{display:grid;grid-template-columns:1fr;gap:1.2rem;margin-top:1rem}
    .card{background:var(--card);border:1px solid #e9e9e9;border-radius:12px; padding:1rem 1rem}
    .hdr{display:flex; flex-wrap:wrap; gap:0.6rem 1.2rem; align-items:baseline; margin-bottom:0.6rem}
    .hdr h2{font-size:1.1rem; margin:0}
    .meta{display:flex;flex-wrap:wrap;gap:0.6rem 1.2rem;color:var(--muted);font-size:0.95rem}
    .tag{display:inline-block; padding:0.15rem 0.5rem; border:1px solid #ddd; border-radius:999px; font-size:0.8rem; color:#333; background:#f6f6f6}
    table{width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums}
    thead th{position:sticky; top:0; background:#f5f7fb; z-index:1}
    th, td{padding:0.5rem 0.6rem; border-bottom:1px solid #eee; text-align:left}
    td.num, th.num{text-align:right}
    tfoot td{font-weight:600}
    .neg{color:#b00020}
    .pos{color:#056d2d}
    .small{font-size:0.9em;color:var(--muted)}
    .notice{font-size:0.95rem;color:#333; background:#fff7e6; border:1px solid #ffe0a3; padding:0.6rem 0.8rem; border-radius:8px; margin:.8rem 0}
    .actions{display:flex;gap:0.6rem;flex-wrap:wrap;margin:.2rem 0 1rem}
    @media print{
      body{background:#fff;padding:0}
      .uploader, .actions, .notice{display:none}
      .card{border:none; border-radius:0; page-break-inside:avoid}
      thead th{position:static}
    }
  </style>
</head>
<body>
  <h1>ABO výpis → HTML/PDF</h1>
  <div class="uploader">
    <input id="file" type="file" accept=".abo,.gpc,.txt" class="btn">
    <button class="btn" id="demo">Načíst ukázku</button>
    <div class="actions">
      <button class="btn" onclick="window.print()">Tisk / Uložit jako PDF</button>
      <button class="btn" id="exportHtml">Stáhnout HTML se zpracovaným obsahem</button>
    </div>
  </div>
  <div class="drop" id="drop">Přetáhni sem soubor ABO/GPC (074/075/078/079), nebo použij „Vybrat soubor“.</div>

  <div id="out" class="cards"></div>

<script>
(function(){
  const out = document.getElementById('out');
  const fileInput = document.getElementById('file');
  const drop = document.getElementById('drop');

  // --- Helpers -------------------------------------------------------------
  const decoders = ['windows-1250','cp1250','iso-8859-2','utf-8'];
  async function decodeBuffer(buf){
    for(const enc of decoders){
      try{
        const td = new TextDecoder(enc, {fatal:false});
        const s = td.decode(buf);
        if (s && s.length) return s;
      }catch(e){/* try next */}
    }
    return new TextDecoder().decode(buf);
  }

  const strip = s => (s||'').replace(/\s+$/,'');
  const ltrimZeros = s => (s||'').replace(/^0+/,'');
  const onlyDigits = s => (s||'').replace(/\D+/g,'');
  const parseIntSafe = s => Number(onlyDigits(s)||'0');

  function parseAmountHalers(str){ // string of digits
    const n = parseIntSafe(str);
    return n/100;
  }
  function fmtCZK(n){ return n.toLocaleString('cs-CZ',{style:'currency',currency:'CZK'}); }
  function fmtNum(n){ return n.toLocaleString('cs-CZ'); }
  function fmtDateDDMMYY(s){
    s = onlyDigits(s);
    if(s.length !== 6) return '';
    const dd = s.slice(0,2), mm = s.slice(2,4), yy = s.slice(4,6);
    const y = Number(yy);
    const full = (y <= 68 ? 2000+y : 1900+y);
    return `${dd}.${mm}.${full}`;
  }
  function formatAccount16(acc16, bankCode){
    const raw = onlyDigits(acc16).padStart(16,'0').slice(-16);
    const prefix = ltrimZeros(raw.slice(0,6));
    const number = ltrimZeros(raw.slice(6));
    const base = (prefix? (prefix+'-') : '') + (number || '0');
    const bank = ltrimZeros(onlyDigits(bankCode||''));
    return bank ? `${base}/${bank.padStart(4,'0')}` : base;
  }
  function parseKSAndBank(field10digits){
    const s = onlyDigits(field10digits).padStart(10,'0');
    const bankCode = ltrimZeros(s.slice(2,6)) || '';
    const ks = ltrimZeros(s.slice(6)) || '';
    return { bankCode, ks };
  }
  function codeToSign(code){
    // 1=debet(-), 2=kredit(+), 4=storno debetu(+) , 5=storno kreditu(-)
    switch(String(code)){
      case '1': return -1;
      case '2': return +1;
      case '4': return +1;
      case '5': return -1;
      default: return 0;
    }
  }
  function codeToDirLabel(code){
    return (code==='1' || code==='5') ? 'Debet' : (code==='2' || code==='4') ? 'Kredit' : '';
  }

  // --- Core parser ---------------------------------------------------------
  function parseABO(text){
    const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(x=>x.trim().length>0);
    /** statements: [{header, items:[], avPendingIndex:-1}] */
    const stmts = [];
    let current = null;

    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      const typ = line.slice(0,3);

      if(typ==='074'){ // Header
        const acc16 = line.slice(3,19);            // 4-19
        const name = strip(line.slice(19,39));     // 20-39
        const oldDate = line.slice(39,45);         // 40-45
        const oldBal = parseAmountHalers(line.slice(45,59));  // 46-59
        const oldSign = line.slice(59,60);         // 60
        const newBal = parseAmountHalers(line.slice(60,74));  // 61-74
        const newSign = line.slice(74,75);         // 75
        const debit = parseAmountHalers(line.slice(75,89));   // 76-89
        const debitSign = line.slice(89,90);       // 90 ('0' or '-')
        const credit = parseAmountHalers(line.slice(90,104)); // 91-104
        const creditSign = line.slice(104,105);    // 105
        const stmtNo = onlyDigits(line.slice(105,108));       // 106-108
        const acctDate = line.slice(108,114);      // 109-114

        current = {
          header: {
            accountRaw: acc16,
            account: formatAccount16(acc16, ''),
            name,
            oldDate: fmtDateDDMMYY(oldDate),
            oldBalance: (oldSign==='-'?-1:1)*oldBal,
            newBalance: (newSign==='-'?-1:1)*newBal,
            debitTurnover: (debitSign==='-'?-1:1)*debit,
            creditTurnover: (creditSign==='-'?-1:1)*credit,
            statementNo: stmtNo,
            accountingDate: fmtDateDDMMYY(acctDate)
          },
          items: [],
        };
        stmts.push(current);
      }
      else if(typ==='075'){ // Item
        if(!current){ current = {header:null, items:[]}; stmts.push(current); }
        const myAcc16 = line.slice(3,19);        // 4-19
        const counterAcc16 = line.slice(19,35);  // 20-35
        const docId = line.slice(35,48);         // 36-48
        const amt = parseAmountHalers(line.slice(48,60));// 49-60
        const code = line.slice(60,61);          // 61
        const vs = ltrimZeros(line.slice(61,71)); // 62-71
        const ksField = line.slice(71,81);       // 72-81
        const {bankCode, ks} = parseKSAndBank(ksField);
        const ss = ltrimZeros(line.slice(81,91)); // 82-91
        const valuta = fmtDateDDMMYY(line.slice(91,97)); // 92-97
        const shortName = strip(line.slice(97,117)); // 98-117
        const changeCode = line.slice(117,118);     // 118
        const dataKind = line.slice(118,122);       // 119-122
        const due = fmtDateDDMMYY(line.slice(122,128)); // 123-128

        const sign = codeToSign(code);
        const amount = sign * amt;

        current.items.push({
          myAccount: formatAccount16(myAcc16,''),
          counterAccount: formatAccount16(counterAcc16, bankCode),
          counterBank: bankCode || '',
          documentId: ltrimZeros(onlyDigits(docId)),
          amount, amtAbs: amt, sign, code, dir: codeToDirLabel(code),
          vs: vs || '', ks: ks || '', ss: ss || '',
          valuta, due,
          shortName,
          changeCode: changeCode || '',
          dataKind: dataKind || '',
          av1:'', av2:'', av3:'', av4:''
        });
      }
      else if(typ==='078' || typ==='079'){
        // Attach AV fields to the last item
        const lastStmt = current || (stmts.length? stmts[stmts.length-1] : null);
        const lastItem = lastStmt && lastStmt.items && lastStmt.items[lastStmt.items.length-1];
        if(lastItem){
          const a = strip(line.slice(3,38));  // 4-38
          const b = strip(line.slice(38,73)); // 39-73
          if(typ==='078'){ lastItem.av1 = a; lastItem.av2 = b; }
          if(typ==='079'){ lastItem.av3 = a; lastItem.av4 = b; }
        }
      }
      // jiné typy ignorujeme
    }

    // Derive totals & simple check
    for(const s of stmts){
      let debit = 0, credit = 0, net = 0;
      for(const it of s.items){
        if(it.sign < 0) debit += Math.abs(it.amount);
        if(it.sign > 0) credit += Math.abs(it.amount);
        net += it.amount;
      }
      s.totals = { debit, credit, net };
      if(s.header){
        const hdr = s.header;
        // Header debit/credit are absolute values with sign flags; compare by abs
        s.check = {
          debitOk: approxEq(Math.abs(hdr.debitTurnover), debit),
          creditOk: approxEq(Math.abs(hdr.creditTurnover), credit),
          newBalanceExpected: (hdr.oldBalance + (credit - debit)),
          newBalanceOk: approxEq(hdr.newBalance, (hdr.oldBalance + (credit - debit)))
        };
      }
    }
    return stmts;
  }

  function approxEq(a,b){ return Math.abs((a||0)-(b||0)) < 0.01; }

  // --- Rendering -----------------------------------------------------------
  function render(stmts){
    out.innerHTML = '';
    if(!stmts.length){
      out.innerHTML = `<div class="notice">V souboru jsem nenašel záznamy 074/075.</div>`;
      return;
    }
    stmts.forEach((s,idx)=>{
      const card = document.createElement('section');
      card.className = 'card';
      const hdr = s.header;
      const badge = (ok) => ok ? '✔' : '⚠';

      card.innerHTML = `
        <div class="hdr">
          <h2>Výpis ${hdr?.statementNo ? `#${hdr.statementNo}`:''} ${hdr?.account ? `— ${hdr.account}`:''}</h2>
          ${hdr?.name ? `<span class="tag">${escapeHtml(hdr.name)}</span>`:''}
        </div>
        <div class="meta">
          ${hdr?`
            <span><strong>Starý zůstatek:</strong> ${fmtCZK(hdr.oldBalance)} (k ${hdr.oldDate})</span>
            <span><strong>Nový zůstatek:</strong> ${fmtCZK(hdr.newBalance)} — kontrola ${badge(s.check.newBalanceOk)}</span>
            <span><strong>Obraty MD/D:</strong> ${fmtCZK(hdr.debitTurnover)} / ${fmtCZK(hdr.creditTurnover)} — kontrola ${badge(s.check.debitOk && s.check.creditOk)}</span>
            <span><strong>Datum výpisu:</strong> ${hdr.accountingDate || '—'}</span>
          `:''}
        </div>
        ${renderTable(s)}
      `;
      out.appendChild(card);
    });
  }

  function renderTable(stmt){
    const rows = stmt.items.map(it=>{
      const msg = [it.av1,it.av2,it.av3,it.av4].filter(Boolean).join(' | ') || it.shortName || '';
      const amtClass = it.amount<0 ? 'neg':'pos';
      const acc = escapeHtml(it.counterAccount || '');
      const bank = it.counterBank ? ` <span class="small">(${it.counterBank})</span>` : '';
      const ids = [
        it.vs ? `VS ${it.vs}`:'',
        it.ks ? `KS ${it.ks}`:'',
        it.ss ? `SS ${it.ss}`:'',
        it.documentId ? `ID ${it.documentId}`:''
      ].filter(Boolean).join(' · ');
      return `
        <tr>
          <td>${it.due || it.valuta || ''}</td>
          <td>${it.dir}</td>
          <td>${acc}${bank}</td>
          <td>${escapeHtml(msg)}</td>
          <td class="small">${ids||''}</td>
          <td class="num ${amtClass}"><strong>${fmtCZK(it.amount)}</strong></td>
        </tr>`;
    }).join('');

    const t = stmt.totals || {debit:0,credit:0,net:0};
    return `
      <div class="actions">
        <button class="btn primary" onclick="window.print()">Uložit jako PDF</button>
      </div>
      <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Směr</th>
            <th>Protiúčet</th>
            <th>Popis</th>
            <th>Identifikátory</th>
            <th class="num">Částka</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="6" class="small">Žádné položky 075.</td></tr>`}</tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="num">Součet kreditů</td>
            <td class="num pos">${fmtCZK(t.credit)}</td>
          </tr>
          <tr>
            <td colspan="5" class="num">Součet debetů</td>
            <td class="num neg">-${fmtCZK(t.debit)}</td>
          </tr>
          <tr>
            <td colspan="5" class="num">Čistá změna</td>
            <td class="num">${fmtCZK(t.net)}</td>
          </tr>
        </tfoot>
      </table>
      </div>
    `;
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // --- File handling -------------------------------------------------------
  async function handleFile(file){
    const buf = await file.arrayBuffer();
    const txt = await decodeBuffer(buf);
    const stmts = parseABO(txt);
    render(stmts);
  }

  fileInput.addEventListener('change', ev=>{
    const f = ev.target.files && ev.target.files[0];
    if(f) handleFile(f);
  });

  // Drag & drop
  ;['dragenter','dragover'].forEach(e=>{
    drop.addEventListener(e, ev=>{ ev.preventDefault(); drop.classList.add('drag'); });
  });
  ;['dragleave','drop'].forEach(e=>{
    drop.addEventListener(e, ev=>{ ev.preventDefault(); drop.classList.remove('drag'); });
  });
  drop.addEventListener('drop', ev=>{
    const f = ev.dataTransfer.files && ev.dataTransfer.files[0];
    if(f) handleFile(f);
  });

  // Export self-contained HTML (with parsed data rendered)
  document.getElementById('exportHtml').addEventListener('click', ()=>{
    const blob = new Blob([document.documentElement.outerHTML], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'abo-vypis.html'});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Tiny demo with 3 položky (syntetická data podle specifikace)
  document.getElementById('demo').addEventListener('click', ()=>{
    const demo =
`0740000000012345678ACME s.r.o.         01012500000000012345+00000000012445+00000000000100-00000000000200+00125010125              \r
075000000001234567800000000000567890001234567890000000001234200000000000002010055800000000001010125Protiúčet A        00203010125\r
078Platba za služby                Faktura 2025/001             \r
075000000001234567800000000000111111001234567891000000004200100000000000002010012300000000002010125Protiúčet B        00203010125\r
079Var. zpráva 3                   Var. zpráva 4                 \r
075000000001234567800000000000222222001234567892000000000999200000000000002010012300000000003010125Úrok                00203010125\r`;
    const stmts = parseABO(demo);
    render(stmts);
  });

})();
</script>
</body>
</html>
